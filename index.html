<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Billing Code Usage Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f4f6f8;
        margin: 0;
        padding: 0;
        color: #333;
      }
      .content {
        flex: 1;
        padding: 2rem 3rem;
        max-width: 900px;
        margin: 0 auto;
      }
      h1 {
        text-align: center;
        padding: 20px;
        margin: 0;
        background: #2c3e50;
        color: white;
        font-weight: 500;
      }

      .container {
        max-width: 900px;
        margin: 30px auto;
        background: white;
        padding: 20px 30px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      label {
        display: inline-block;
        margin: 10px 15px 10px 0;
        font-weight: 500;
      }

      input[type="file"],
      input[type="text"],
      input[type="date"] {
        margin-top: 5px;
        padding: 6px 8px;
        border: 1px solid #ccc;
        border-radius: 6px;
      }

      button {
        margin: 10px 5px 20px 0;
        padding: 10px 18px;
        font-size: 14px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
      }

      #process {
        background: #2980b9;
        color: white;
      }
      #process:hover {
        background: #1f6390;
      }

      #generate {
        background: #27ae60;
        color: white;
      }
      #generate:disabled {
        background: #95a5a6;
        cursor: not-allowed;
      }
      #generate:hover:not(:disabled) {
        background: #1e874b;
      }

      h2 {
        margin-top: 0;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }

      table th,
      table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
      }

      table th {
        background-color: #2980b9;
        color: white;
      }

      table tr:nth-child(even) {
        background-color: #f9f9f9;
      }

      table tr:hover {
        background-color: #f1f1f1;
      }

      table tr:last-child {
        font-weight: bold;
        background: #ecf0f1;
      }

      footer {
        text-align: center;
        padding: 15px;
        font-size: 13px;
        color: #666;
        background: #f9f9f9;
        border-top: 1px solid #ddd;
        margin-top: 40px;
      }
    </style>
  </head>
  <body>
    <main>
      <h1>Sharp Billing Code Calculator</h1>
      <div class="content">
        <input type="file" id="csvFile" accept=".csv" /><br /><br />

        <label>Billing Code / Name: <input type="text" id="searchTerm" /></label
        ><br /><br />
        <label>Start Date: <input type="date" id="startDate" /></label>
        <label>End Date: <input type="date" id="endDate" /></label><br /><br />

        <button id="process">Process Data</button>
        <button id="generate" disabled>Generate PDF Report</button>

        <h2>Preview</h2>
        <div id="preview"></div>
      </div>
    </main>

    <script>
      let previewData = null;

      // Map billing codes to customer names
      const customerMap = {
        1: "Washington Plaza",
        2: "The Oaks",
        3: "Guest House",
        5: "CPC & CPPP",
        9: "PHM Corp",
        12: "Nursing Home Split",
      };

      // Helper to resolve billing code name
      function getCustomerName(code) {
        return customerMap[code] ? `${code} - ${customerMap[code]}` : code;
      }

      const sanitize = (str) => str.replace(/[^\x20-\x7E]/g, "");

      document.getElementById("process").addEventListener("click", () => {
        const file = document.getElementById("csvFile").files[0];
        const searchTerm = document.getElementById("searchTerm").value.trim();
        const startDate = new Date(document.getElementById("startDate").value);
        const endDate = new Date(document.getElementById("endDate").value);

        if (!file || !searchTerm || isNaN(startDate) || isNaN(endDate)) {
          alert(
            "Please select a file, enter a billing code/name, and a valid date range."
          );
          return;
        }

        Papa.parse(file, {
          header: true,
          complete: function (results) {
            const rows = results.data;
            const matches = [];
            let totals = {
              bw: 0,
              color: 0,
              twoColor: 0,
              singleColor: 0,
              grand: 0,
            };

            rows.forEach((row) => {
              const code = row["Main Code"];
              const user = row["User Name"];
              const completed = new Date(row["Completing Date & Time"]);
              const bw = parseInt(row["Black & White Total Count"] || 0);
              const color = parseInt(row["Full Color Total Count"] || 0);
              const twoColor = parseInt(row["2-Color Total Count"] || 0);
              const singleColor = parseInt(
                row["Single Color Total Count"] || 0
              );

              if (
                (code && code.toString().includes(searchTerm)) ||
                (user &&
                  user
                    .toString()
                    .toLowerCase()
                    .includes(searchTerm.toLowerCase()))
              ) {
                if (completed >= startDate && completed <= endDate) {
                  const rowGrand = bw + color + twoColor + singleColor;
                  matches.push([
                    completed.toISOString().split("T")[0], // date only
                    bw,
                    color,
                    twoColor,
                    singleColor,
                    rowGrand,
                  ]);

                  totals.bw += bw;
                  totals.color += color;
                  totals.twoColor += twoColor;
                  totals.singleColor += singleColor;
                  totals.grand += rowGrand;
                }
              }
            });

            const resolvedName = getCustomerName(searchTerm);

            previewData = {
              searchTerm,
              resolvedName,
              startDate,
              endDate,
              matches,
              totals,
            };
            renderPreview(previewData);

            // enable PDF button
            document.getElementById("generate").disabled = matches.length === 0;
          },
        });
      });

      function renderPreview(data) {
        const container = document.getElementById("preview");
        container.innerHTML = "";

        if (data.matches.length === 0) {
          container.innerHTML = "<p>No matching results found.</p>";
          return;
        }

        let html = `
        <p><strong>Billing Code / Name:</strong> ${sanitize(
          data.resolvedName
        )}</p>
        <p><strong>Date Range:</strong> ${
          data.startDate.toISOString().split("T")[0]
        } - ${data.endDate.toISOString().split("T")[0]}</p>
        <table border="1" cellpadding="5" cellspacing="0">
          <tr>
            <th>Completed Date</th>
            <th>B&W</th>
            <th>Full Color</th>
            <th>2-Color</th>
            <th>Single Color</th>
            <th>Row Grand Total</th>
          </tr>`;

        data.matches.forEach((row) => {
          html += `
          <tr>
            <td>${row[0]}</td>
            <td>${row[1]}</td>
            <td>${row[2]}</td>
            <td>${row[3]}</td>
            <td>${row[4]}</td>
            <td>${row[5]}</td>
          </tr>`;
        });

        html += `
        <tr style="font-weight:bold; background:#eee;">
          <td>TOTALS</td>
          <td>${data.totals.bw}</td>
          <td>${data.totals.color}</td>
          <td>${data.totals.twoColor}</td>
          <td>${data.totals.singleColor}</td>
          <td>${data.totals.grand}</td>
        </tr>
        </table>`;

        container.innerHTML = html;
      }

      document.getElementById("generate").addEventListener("click", () => {
        if (!previewData) return;
        generatePDF(previewData);
      });

      function generatePDF(data) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(16);
        doc.text("Billing Code Usage Report", 14, 20);

        doc.setFontSize(12);
        doc.text(`Billing Code / Name: ${sanitize(data.resolvedName)}`, 14, 30);
        doc.text(
          `Date Range: ${data.startDate.toISOString().split("T")[0]} - ${
            data.endDate.toISOString().split("T")[0]
          }`,
          14,
          38
        );

        const headers = [
          [
            "Completed Date",
            "B&W",
            "Full Color",
            "2-Color",
            "Single Color",
            "Row Grand Total",
          ],
        ];
        const summaryRow = [
          "TOTALS",
          data.totals.bw,
          data.totals.color,
          data.totals.twoColor,
          data.totals.singleColor,
          data.totals.grand,
        ];

        const tableData = [...data.matches, summaryRow];

        doc.autoTable({
          head: headers,
          body: tableData,
          startY: 45,
          styles: { halign: "center" },
          headStyles: {
            fillColor: [41, 128, 185],
            textColor: 255,
            fontStyle: "bold",
          },
          footStyles: { fillColor: [200, 200, 200] },
        });

        doc.save("billing_report.pdf");
      }
    </script>
    <footer>
      created by <strong>Brobinson App Solutions</strong> powered by
      <strong>MOEbiz</strong>
    </footer>
  </body>
</html>
