<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Billing Code Usage Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f8fafc;
        color: #1e293b;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      header {
        background: #0f172a;
        color: white;
        padding: 1rem 2rem;
        text-align: center;
        font-size: 1.25rem;
        font-weight: 600;
      }
      main {
        flex: 1;
        padding: 2rem 2rem;
        max-width: 1000px;
        margin: 0 auto;
        width: 100%;
      }
      .content {
        padding-left: 2.5rem; /* extra left breathing room */
      }
      label {
        display: block;
        margin: 0.5rem 0 0.2rem;
        font-weight: 600;
      }
      input[type="file"],
      input[type="text"],
      input[type="date"] {
        padding: 0.55rem 0.7rem;
        border-radius: 6px;
        border: 1px solid #cbd5e1;
        width: 100%;
        box-sizing: border-box;
        margin-bottom: 0.75rem;
      }
      .row {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: flex-end;
      }
      .col {
        flex: 1 1 200px;
        min-width: 160px;
      }
      button {
        padding: 0.6rem 1rem;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        margin-right: 0.5rem;
      }
      #process {
        background: #2563eb;
        color: white;
      }
      #generate {
        background: #16a34a;
        color: white;
      }
      #generate:disabled {
        background: #94a3b8;
        cursor: not-allowed;
      }
      h2 {
        margin-top: 1.25rem;
      }
      #preview table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0.6rem;
        background: white;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        border-radius: 6px;
        overflow: hidden;
      }
      #preview th,
      #preview td {
        padding: 0.6rem 0.8rem;
        border-bottom: 1px solid #e6eef6;
        text-align: left;
      }
      #preview th {
        background: #f1f5f9;
        text-transform: uppercase;
        font-size: 0.85rem;
        color: #475569;
      }
      #preview tr:nth-child(even) td {
        background: #fbfdff;
      }
      #preview tr.total-row td {
        font-weight: 700;
        background: #eef2f7;
      }
      footer {
        background: #f1f5f9;
        text-align: center;
        padding: 1rem;
        font-size: 0.9rem;
        color: #64748b;
        margin-top: 1.5rem;
      }
      footer strong {
        color: #0f172a;
      }
    </style>
  </head>
  <body>
    <header>Sharp Billing Code Calculator</header>

    <main>
      <div class="content">
        <div style="margin-bottom: 0.5rem">
          <input type="file" id="csvFile" accept=".csv" />
        </div>

        <div class="row">
          <div class="col">
            <label for="searchTerm">Billing Code / Name</label>
            <input
              id="searchTerm"
              type="text"
              placeholder="Enter exact billing code"
            />
          </div>

          <div class="col">
            <label for="startDate">Start Date</label>
            <input id="startDate" type="date" />
          </div>

          <div class="col">
            <label for="endDate">End Date</label>
            <input id="endDate" type="date" />
          </div>
        </div>

        <div style="margin-top: 0.75rem">
          <button id="process">Process Data</button>
          <button id="generate" disabled>Generate PDF Report</button>
        </div>

        <h2>Preview</h2>
        <div id="preview"></div>
      </div>
    </main>

    <footer>
      A <strong>Brobinson</strong> application powered by
      <strong>MOEbiz</strong>
    </footer>

    <script>
      /* ------------------------
   Helpers and configuration
   ------------------------ */
      const customerMap = {
        1: "Washington Plaza",
        2: "The Oaks",
        3: "Guest House",
        5: "CPC & CPPP",
        9: "PHM Corp",
        12: "Nursing Home Split",
      };

      function getCustomerName(code) {
        // If code is like "1" return "1 - Washington Plaza"
        return code in customerMap ? `${code} - ${customerMap[code]}` : code;
      }

      // Robust sanitize (remove BOMs, zero-widths, smart quotes, then non-printable)
      function sanitize(str) {
        if (str === undefined || str === null) return "";
        return String(str)
          .replace(/[\u200B-\u200D\uFEFF]/g, "")
          .replace(/[“”]/g, '"')
          .replace(/[‘’]/g, "'")
          .replace(/[^\x20-\x7E]/g, "")
          .trim();
      }

      function parseCount(v) {
        if (v === undefined || v === null || v === "") return 0;
        // remove commas and other non-digit chars (except minus)
        const cleaned = String(v)
          .replace(/,/g, "")
          .replace(/[^\d-]/g, "");
        const n = parseInt(cleaned, 10);
        return Number.isNaN(n) ? 0 : n;
      }

      /* ------------------------Main logic------------------------ */
      let previewData = null;

      document.getElementById("process").addEventListener("click", () => {
        const file = document.getElementById("csvFile").files[0];
        const rawSearch = document.getElementById("searchTerm").value;
        const searchTerm = sanitize(rawSearch);
        const startDateInput = document.getElementById("startDate").value;
        const endDateInput = document.getElementById("endDate").value;

        if (!file || !searchTerm || !startDateInput || !endDateInput) {
          alert(
            "Please select a CSV, enter a billing code/name, and pick start/end dates."
          );
          return;
        }

        // Normalize date boundaries (use local midnight)
        const startDate = new Date(startDateInput + "T00:00:00");
        const endDate = new Date(endDateInput + "T23:59:59.999");

        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: function (results) {
            const rows = results.data;
            const matches = [];
            let totals = {
              bw: 0,
              color: 0,
              twoColor: 0,
              singleColor: 0,
              grand: 0,
            };

            // For exact matching: get normalized lower-case search term for comparison
            const searchNorm = searchTerm.toLowerCase();

            rows.forEach((row) => {
              // read and sanitize relevant fields
              const rawCode = row["Main Code"];
              const code = sanitize(rawCode);
              const codeNorm = code.toLowerCase();

              const rawUser = row["User Name"];
              const user = sanitize(rawUser);
              const userNorm = user.toLowerCase();

              const rawComplete = sanitize(row["Completing Date & Time"]);
              // Expecting ISO-like timestamp with "T", but we handle gracefully.
              const completeDateObj = rawComplete
                ? new Date(rawComplete)
                : null;
              if (!completeDateObj || Number.isNaN(completeDateObj.getTime()))
                return; // skip invalid dates

              // Check date inclusion (either start or complete could be considered in original spec,
              // but user requested row counts if either falls within range — we already use Completing Date)
              const completesInRange =
                completeDateObj >= startDate && completeDateObj <= endDate;

              // MATCH LOGIC:
              // - exact match on MAIN CODE (string equality) OR
              // - partial match within USER NAME (case-insensitive)
              const isCodeExactMatch = codeNorm === searchNorm;
              const isUserPartialMatch = userNorm.includes(searchNorm);

              if (
                (isCodeExactMatch || isUserPartialMatch) &&
                completesInRange
              ) {
                // counts
                const bw = parseCount(row["Black & White Total Count"]);
                const full = parseCount(row["Full Color Total Count"]);
                const two = parseCount(row["2-Color Total Count"]);
                const single = parseCount(row["Single Color Total Count"]);
                const rowGrand = bw + full + two + single;

                matches.push({
                  complete: rawComplete,
                  completedDateOnly: completeDateObj
                    .toISOString()
                    .split("T")[0],
                  bw,
                  full,
                  two,
                  single,
                  rowGrand,
                });

                totals.bw += bw;
                totals.color += full;
                totals.twoColor += two;
                totals.singleColor += single;
                totals.grand += rowGrand;
              }
            });

            // Prepare resolved name (show both code and mapped name if code is numeric and mapped)
            const resolvedName =
              searchTerm in customerMap
                ? getCustomerName(searchTerm)
                : searchTerm;

            previewData = {
              searchTerm,
              resolvedName,
              startDate: startDate,
              endDate: endDate,
              matches,
              totals,
            };
            renderPreview(previewData);

            // enable PDF only if we have matches
            document.getElementById("generate").disabled = !matches.length;
          },
          error: function (err) {
            alert("Error parsing CSV: " + err);
          },
        });
      });

      function renderPreview(data) {
        const container = document.getElementById("preview");
        container.innerHTML = "";

        if (!data.matches || data.matches.length === 0) {
          container.innerHTML = "<p>No matching results found.</p>";
          return;
        }

        let html = `<p><strong>Billing Code / Name:</strong> ${sanitize(
          data.resolvedName
        )}</p>`;
        html += `<p><strong>Date Range:</strong> ${
          data.startDate.toISOString().split("T")[0]
        } - ${data.endDate.toISOString().split("T")[0]}</p>`;

        html += `<table><thead><tr>
    <th>Completed Date</th><th>Completing Date & Time</th><th>B&amp;W</th><th>Full Color</th><th>2-Color</th><th>Single Color</th><th>Row Grand Total</th>
  </tr></thead><tbody>`;

        data.matches.forEach((r) => {
          html += `<tr>
      <td>${r.completedDateOnly}</td>
      <td>${sanitize(r.complete)}</td>
      <td>${r.bw}</td>
      <td>${r.full}</td>
      <td>${r.two}</td>
      <td>${r.single}</td>
      <td>${r.rowGrand}</td>
    </tr>`;
        });

        html += `<tr class="total-row">
    <td>TOTALS</td>
    <td></td>
    <td>${data.totals.bw}</td>
    <td>${data.totals.color}</td>
    <td>${data.totals.twoColor}</td>
    <td>${data.totals.singleColor}</td>
    <td>${data.totals.grand}</td>
  </tr>`;

        html += `</tbody></table>`;

        container.innerHTML = html;
      }

      document.getElementById("generate").addEventListener("click", () => {
        if (!previewData || !previewData.matches.length) return;
        generatePDF(previewData);
      });

      function generatePDF(data) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: "pt", format: "letter" });

        doc.setFontSize(16);
        doc.text("Billing Code Usage Report", 40, 50);

        doc.setFontSize(11);
        doc.text(`Billing Code / Name: ${sanitize(data.resolvedName)}`, 40, 72);
        doc.text(
          `Date Range: ${data.startDate.toISOString().split("T")[0]} - ${
            data.endDate.toISOString().split("T")[0]
          }`,
          40,
          90
        );

        // build rows for autotable
        const tableBody = data.matches.map((r) => [
          r.completedDateOnly,
          sanitize(r.complete),
          r.bw,
          r.full,
          r.two,
          r.single,
          r.rowGrand,
        ]);

        // append totals row
        tableBody.push([
          "TOTALS",
          "",
          data.totals.bw,
          data.totals.color,
          data.totals.twoColor,
          data.totals.singleColor,
          data.totals.grand,
        ]);

        doc.autoTable({
          head: [
            [
              "Completed Date",
              "Completing Date & Time",
              "B&W",
              "Full Color",
              "2-Color",
              "Single Color",
              "Row Grand Total",
            ],
          ],
          body: tableBody,
          startY: 110,
          styles: { halign: "center", cellPadding: 6, fontSize: 10 },
          headStyles: {
            fillColor: [41, 128, 185],
            textColor: 255,
            fontStyle: "bold",
          },
          footStyles: {
            fillColor: [230, 230, 230],
            textColor: 0,
            fontStyle: "bold",
          },
          didDrawPage: function (dataPage) {
            // optional: could add page footer text here
          },
        });

        doc.save("billing_report.pdf");
      }
    </script>
  </body>
</html>
